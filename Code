from dotenv import dotenv_values
import openai
import sqlite3
import telebot
from requests.exceptions import ReadTimeout
from openai.error import RateLimitError, InvalidRequestError

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ ÐºÐ»Ð°ÑÑÐ° Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð±Ð¾Ñ‚Ð°
bot1 = telebot.TeleBot("TOKEN1")

env = {
    **dotenv_values(".env.prod"),
    **dotenv_values(".env.dev"),  # override
}

API_KEYS_CHATGPT = [
    env["API_KEY_CHATGPT"],
]
bot1 = telebot.TeleBot(env["TG_BOT_TOKEN1"])
db_link = env["DB_LINK"]


def write_to_db(message):
    conn = sqlite3.connect(db_link)
    cursor = conn.cursor()
    select_id = cursor.execute(
        "SELECT id FROM user WHERE chat_id = ?", (str(message.chat.id),)
    )
    select_id = select_id.fetchone()
    if select_id:
        try:
            cursor.execute(
                "UPDATE user SET last_msg=?, last_login=? WHERE chat_id=?",
                (
                    message.text,
                    str(message.date),
                    str(message.chat.id),
                ),
            )
        except:
            conn.commit()
            conn.close()
            bot1.send_message(
                612063160,
                f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ (INSERT) Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ð±Ð°Ð·Ðµ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: {message.chat.id}",
            )
    else:
        try:
            cursor.execute(
                "INSERT INTO user (chat_id, last_login, username, first_name, last_name, last_msg) VALUES (?,?,?,?,?,?)",
                (
                    str(message.chat.id),
                    str(message.date),
                    message.chat.username if message.chat.username else "-",
                    message.chat.first_name
                    if message.chat.first_name
                    else "-",
                    message.chat.last_name if message.chat.last_name else "-",
                    message.text,
                ),
            )
        except:
            conn.commit()
            conn.close()
            bot1.send_message(
                612063160,
                f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ (INSERT) Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Ð±Ð°Ð·Ðµ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: {message.chat.id}",
            )
    conn.commit()
    conn.close()


def check_length(answer, list_of_answers):
    if len(answer) > 4090 and len(answer) < 409000:
        list_of_answers.append(answer[0:4090] + "...")
        check_length(answer[4091:], list_of_answers)
    else:
        list_of_answers.append(answer[0:])
        return list_of_answers


def make_request(message, api_key_numb):
    try:
        engine = "text-davinci-003"
        completion = openai.Completion.create(
            engine=engine,
            prompt=message.text,
            temperature=0.5,
            max_tokens=3100,
        )
        list_of_answers = check_length(completion.choices[0]["text"], [])
        if list_of_answers:
            for piece_of_answer in list_of_answers:
                bot1.send_message(message.chat.id, piece_of_answer)
        else:
            make_request(message, api_key_numb)
    except RateLimitError:
        if api_key_numb < len(API_KEYS_CHATGPT) - 1:
            api_key_numb += 1
            openai.api_key = API_KEYS_CHATGPT[api_key_numb]
            make_request(message, api_key_numb)
        else:
            if not key_end:
                bot1.send_message(
                    612063160,
                    f"ÐšÐ»ÑŽÑ‡Ð¸ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»Ð¸ÑÑŒ!!!",
                )
            key_end = True
            bot1.send_message(
                message.chat.id,
                "ChatGPT Ð² Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶ÐµÐ½ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ‡ÑƒÑ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ.",
            )
    except ReadTimeout:
        bot1.send_message(
            message.chat.id,
            "ChatGPT Ð² Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶ÐµÐ½ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ‡ÑƒÑ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ.",
        )
    except InvalidRequestError:
        bot1.send_message(
            message.chat.id,
            "ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð´Ð»Ð¸Ð½Ð° ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð¾ÐºÐ¾Ð»Ð¾ 3000 ÑÐ»Ð¾Ð², Ð¾Ñ‚Ð²ÐµÑ‚ Ð¿Ñ€ÐµÐ²Ñ‹ÑÐ¸Ð» Ð´Ð»Ð¸Ð½Ñƒ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ Ð²Ð¾Ð¿Ñ€Ð¾Ñ, Ð»Ð¸Ð±Ð¾ Ð¿ÐµÑ€ÐµÑ„Ñ€Ð°Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐµÐ³Ð¾.",
        )


def create_table():
    """Create table if not exists."""

    conn = sqlite3.connect(db_link)
    cursor = conn.cursor()
    cursor.execute(
        """
        CREATE TABLE IF NOT EXISTS user(
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id TEXT,
            last_login TEXT,
            username TEXT,
            first_name TEXT,
            last_name TEXT,
            last_msg TEXT
        );
        """
    )
    conn.commit()
    conn.close()


@bot1.message_handler(commands=["start"])
def send_start(message):
    text = """ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽ. Ð Ð°Ð´ Ð²Ð¸Ð´ÐµÑ‚ÑŒðŸ˜»\n\nðŸ’¬ Ð¯ Ð˜ÑÑÐºÑƒÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð˜Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ðŸ¤–, Ð¸  Ð³Ð¾Ñ‚Ð¾Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° Ð»ÑŽÐ±Ð¾Ð¹ Ñ‚Ð²Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ! ðŸ’\n\n      ðŸ—£ - Ð¼ÑƒÐ»ÑŒÑ‚Ð¸ÑÐ·Ñ‹ÐºÐ¾Ð²Ð°Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°\n      ðŸ”± - Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð±ÐµÑÐµÐ´     \n      ðŸ¤³ - ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°\n      ðŸ§  - Ð¿Ð¾Ð¸ÑÐº Ð¸ Ð°Ð½Ð°Ð»Ð¸Ð· Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸\n      ðŸ’¢ - Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ\n      ðŸŒ€ - Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡ Ð¸ ÑƒÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ð¹\n\nÐ¡ÐºÐ¾Ñ€ÐµÐµ Ð¿Ð¸ÑˆÐ¸ Ð¸ ÑƒÐ±ÐµÐ´Ð¸ÑÑŒ ÑÐ°Ð¼! â¤µï¸ â¤µï¸ â¤µï¸
"""
    write_to_db(message)
    bot1.send_message(message.chat.id, text)

@bot1.message_handler(content_types=["text"])
def send_msg_to_chatgpt(message):
    api_key_numb = 0
    openai.api_key = API_KEYS_CHATGPT[api_key_numb]
    write_to_db(message)
    make_request(message, api_key_numb)

def inlinequery(update, _):
    """ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°."""
    # Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
    query = update.inline_query.query
    # Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ‚Ð¾Ð³Ð¾
    # Ñ‡Ñ‚Ð¾ Ð²Ñ‹Ð±ÐµÑ€ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¸Ð· Ñ‚Ð°Ðº Ð½Ð°Ð·Ñ‹Ð²Ð°ÐµÐ¼Ð¾Ð³Ð¾
    # Ð¼ÐµÐ½ÑŽ `title`.
    results = [
        # ÐÑ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚ `id` ÑÐ»ÑƒÐ¶Ð¸Ñ‚ Ð´Ð»Ñ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¸Ð· `title` Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°
        #  Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ, Ð² `id` Ñ‚Ð°Ðº Ð¶Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ñ€Ð¾ÐºÑƒ,
        # Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ÑƒÑŽ Ð² `title`, ÐµÑÐ»Ð¸ ÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾ Ð¾Ð½Ð° ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð°Ñ
        InlineQueryResultArticle(
            id=str(uuid4()),
            title="UPPER",
            input_message_content=InputTextMessageContent(query.upper()),
        ),
        InlineQueryResultArticle(
            id=str(uuid4()),
            title="BOLD",
            input_message_content=InputTextMessageContent(
                f"*{escape_markdown(query)}*", parse_mode=ParseMode.MARKDOWN
            ),
        ),
        InlineQueryResultArticle(
            id=str(uuid4()),
            title="ITALIC",
            input_message_content=InputTextMessageContent(
                f"_{escape_markdown(query)}_", parse_mode=ParseMode.MARKDOWN
            ),
        ),
    ]
    # Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð¼
    update.inline_query.answer(results)

if __name__ == "__main__":
    key_end = False
    create_table()
    target = bot1.infinity_polling()

